<%- include('../partials/header') %>
<%- include('../partials/subheader') %>

<% if (meditems.length > 0) { %>
<table id="current-stock-table">
    <thead>
        <tr>
            <th></th>
            <th>Generic Name</th>
            <th>Dose/Form</th>
            <th>Family <img src="/images/filter.svg" alt="" id="filter-icon"></th>
            <th>Nearest Exp.</th>
            <th>Par Level</th>
            <th>Current Stock</th>
        </tr>
    </thead>
    <tbody>
        <% families.forEach((family) => { %>
            <% if (meditems.some(item => item.family === family.name)) { %>
                <tr class="family-header">
                    <td colspan="7"><%= family.name %></td>
                </tr>
            <% } %>
            <% meditems.forEach((item) => { %>
                <% if (item.family === family.name) { %>
                    <tr data-id="<%= item.id %>">
                        <td><img src="/images/star-outline.svg" alt="" class="star-toggle" id="star-table"></td>
                        <td><%= item.genericName %></td>
                        <td><%= item.dose %> <%= item.form %></td>
                        <td><%= item.family %></td>
                        <td><% if (item.firstExp) { %>
                            <%= new Date(item.firstExp).toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' }) %>
                            <% } else { %>
                                --
                                <% } %>
                        </td>
                        <td><%= item.parLevel %></td>
                        <td><%= item.totalStock %></td>
                    </tr>
                <% } %>
            <% }); %>
        <% }); %>
    </tbody>
</table>

<% } else { %>

Sorry, there don't appear to be any items in the system. Click the (+) button at top-right to add some.

<% } %>


<section id="overlay"></section>

<script>
    const overlay = document.getElementById('overlay')
    
    document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('tr[data-id]').forEach(row => {
        row.addEventListener('click', function() {
            const itemId = this.dataset.id;
            fetch(`/current/${itemId}`)
                .then(response => response.text())
                .then(html => {
                    overlay.innerHTML = html;
                overlay.style.display = 'flex'; 
                setTimeout(() => overlay.style.opacity = '1', 10); 
            })
                .catch(err => console.error(err));
        });
    });
});

document.body.addEventListener('click', function(event) {
    if (event.target.id === 'close-text') {
        overlay.style.opacity = '0';
        setTimeout(() => {
            overlay.style.display = 'none';
            overlay.innerHTML = '';
        }, 300);
    }
});

function quickDelete(stockId, meditemId) {
        fetch(`/current/${meditemId}/stock/${stockId}`, { method: 'DELETE' })
            .then(response => {
                if (response.ok) {
                    window.location.reload();
                } else {
                    alert('An error occurred while deleting the stock.');
                }
            })
            .catch(err => {
                console.error('Error:', err);
            });
}


function edit(meditemId) {
    fetch(`/current/${meditemId}/edit`)
                .then(response => response.text())
                .then(html => {
                    overlay.innerHTML = html;
                overlay.style.display = 'flex'; 
                setTimeout(() => overlay.style.opacity = '1', 10); 
            })
                .catch(err => console.error(err));
        }


function confirmDelete(meditemId) {
    if (confirm('Are you sure you want to delete this item?')) {
        fetch(`/current/${meditemId}`, { method: 'DELETE' })
            .then(response => {
                if (response.ok) {
                    window.location.href = '/current';
                } else {
                    alert('An error occurred while deleting the item.');
                }
            })
            .catch(err => {
                console.log(err);
            });
    }
}



function addStock(stockId, meditemId) {
    fetch(`/log/${meditemId}/stock/${stockId}/add`)
        .then(response => response.text())
        .then(html => {
            overlay.innerHTML = html;
            overlay.style.display = 'flex'; 
                setTimeout(() => overlay.style.opacity = '1', 10); 
                })
        .catch(err => console.error(err));
}

function depleteStock(stockId, meditemId) {
    fetch(`/log/${meditemId}/stock/${stockId}/deplete`)
        .then(response => response.text())
        .then(html => {
            overlay.innerHTML = html;
            overlay.style.display = 'flex'; 
                setTimeout(() => overlay.style.opacity = '1', 10); 
                })
        .catch(err => console.error(err));
}

</script>


<%- include('../partials/footer') %>